# Feature Spec: Authentication & Role-Based Access Control

## Overview

Add user authentication, role-based permissions, and estimate status workflow to the Steel Estimator application. Users should see their name and role in the top-right corner of every page. Access to estimates should be controlled by user role and estimate status (Draft vs. Published).

---

## 1. Authentication

### Login Page
- Email/password login form at `/login`
- "Forgot Password" flow with email reset link
- Redirect unauthenticated users to the login page automatically
- After login, redirect to the main dashboard

### User Display (Global Header)
- Top-right corner of every page should show:
  - User's full name
  - Their role (e.g., "Admin" badge)
  - A dropdown menu with: My Profile, Settings (if Admin), Logout

### Session Management
- Persistent login sessions (don't require login on every visit)
- Secure session handling with proper token expiration
- Logout clears session and redirects to login page

---

## 2. User Roles

Four roles, listed from most to least access:

### Admin
- Full access to everything
- Can create, edit, delete, and publish estimates
- Can reopen/unlock a published estimate for editing
- Can access the Admin Panel to manage users
- Can assign roles to other users
- **Initial Admins:** Todd and the Lead Estimator (these two accounts should be seeded on first deploy)

### Estimator
- Can create new estimates
- Can edit estimates in Draft or In Review status
- Cannot edit Published estimates (read-only)
- Cannot publish estimates (only Admins can publish)
- Cannot access Admin Panel or manage users

### Project Manager (Viewer)
- Can only see estimates that have been Published
- Read-only access — no editing capability
- Cannot see Draft or In Review estimates
- Cannot access Admin Panel

### Field/Shop (Viewer - Limited)
- Same as Project Manager but may be scoped to only see estimates assigned to their projects
- Read-only access
- This role is optional for initial build — can be added later if not practical now

---

## 3. Admin Panel

Accessible only to Admin users. Located at `/admin` or via a link in the user dropdown menu.

### User Management Screen
- Table of all users showing: Name, Email, Role, Status (Active/Inactive), Last Login
- "Add User" button — form to create a new user with: First Name, Last Name, Email, Role (dropdown), Temporary Password
- New users should receive an email invitation or be given a temporary password to log in
- Edit button on each user row to change their role or deactivate their account
- Deactivate (not delete) users — preserve their history and audit trail
- Search/filter by role

---

## 4. Estimate Status Workflow

Estimates should have a status field that controls visibility and edit permissions:

### Statuses
1. **Draft** — Default status when a new estimate is created. Only visible to Admins and Estimators. Fully editable by Admins and Estimators.
2. **In Review** — Estimator marks it ready for review. Still only visible to Admins and Estimators. Editable by Admins and Estimators.
3. **Published** — Admin publishes the estimate. Now visible to all roles (including Project Managers/Viewers). Read-only for everyone except Admins.
4. **Reopened** — Admin unlocks a Published estimate for revisions. Behaves like Draft (visible and editable by Admins and Estimators, hidden from Viewers). When revisions are complete, Admin re-publishes it.

### Status Transition Rules
- Draft → In Review (by Estimator or Admin)
- In Review → Published (by Admin only)
- Published → Reopened (by Admin only)
- Reopened → Published (by Admin only)
- Any status → Draft (by Admin only, as a reset)

### UI for Status
- Show current status as a badge/chip on the estimate header
- Status change buttons or dropdown available based on the user's role and current status
- Confirmation dialog before publishing ("Are you sure you want to publish this estimate? It will become visible to Project Managers and Viewers.")
- Confirmation dialog before reopening ("This will hide the estimate from Viewers until it is re-published.")

---

## 5. Permissions Summary Table

| Action | Admin | Estimator | PM/Viewer |
|---|---|---|---|
| Create estimate | ✅ | ✅ | ❌ |
| Edit Draft estimate | ✅ | ✅ | ❌ |
| Edit In Review estimate | ✅ | ✅ | ❌ |
| Edit Published estimate | ✅ | ❌ | ❌ |
| View Draft estimate | ✅ | ✅ | ❌ |
| View In Review estimate | ✅ | ✅ | ❌ |
| View Published estimate | ✅ | ✅ | ✅ |
| Publish estimate | ✅ | ❌ | ❌ |
| Reopen published estimate | ✅ | ❌ | ❌ |
| Delete estimate | ✅ | ❌ | ❌ |
| Access Admin Panel | ✅ | ❌ | ❌ |
| Manage users | ✅ | ❌ | ❌ |

---

## 6. Database Changes Needed

### Users Table
- id, email, password_hash, first_name, last_name, role, status (active/inactive), created_at, updated_at, last_login_at

### Estimates Table (modify existing)
- Add: status (enum: draft, in_review, published, reopened)
- Add: published_by (user id, nullable)
- Add: published_at (timestamp, nullable)
- Add: created_by (user id)

### Audit Log Table (nice to have)
- id, user_id, action (e.g., "published_estimate", "changed_role"), target_type, target_id, timestamp, details (JSON)

---

## 7. Technical Preferences

- Use whatever auth library works best with the current Next.js setup (NextAuth, Clerk, or Supabase Auth are all fine)
- Passwords should be hashed — never stored in plain text
- API routes should validate user role server-side, not just hide UI elements
- Role checks should happen on both the frontend (hide/show UI) and backend (reject unauthorized API calls)

---

## 8. Future Considerations (Do Not Build Yet)

These are planned for later phases — just be aware of them so the architecture doesn't paint us into a corner:

- **Lightweight CRM** — Client and contractor directory tied to projects, with contact info and bid history tracking
- **Estimate versioning** — Track revision history when a published estimate is reopened and re-published
- **Notifications** — Email or in-app alerts when an estimate is published or status changes
- **Field/Shop scoped access** — Limit certain Viewer users to only see estimates for projects they're assigned to
